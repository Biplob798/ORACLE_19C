-- Create the user
CREATE USER SCMDB IDENTIFIED BY s; 
-- Grant unlimited tablespace (so the user can create objects)
ALTER USER SCMDB QUOTA UNLIMITED ON USERS;  -- assuming default tablespace is USERS

-- Grant basic privileges
GRANT CREATE SESSION TO SCMDB;
GRANT CREATE TABLE TO SCMDB;
GRANT CREATE VIEW TO SCMDB;
GRANT CREATE SEQUENCE TO SCMDB;
GRANT CREATE PROCEDURE TO SCMDB;
GRANT CREATE TRIGGER TO SCMDB;
GRANT CREATE TYPE TO SCMDB;

-- Grant full access (admin privileges)
GRANT DBA TO SCMDB;  -- gives all privileges (use carefully)

-- Optional: Grant connect role
GRANT CONNECT, RESOURCE TO SCMDB;



-- DEPARTMENTS table
CREATE TABLE DEPARTMENTS (
    DEPARTMENT_ID NUMBER NOT NULL,
    DEPARTMENT_NAME VARCHAR2(100) NOT NULL,
    DESCRIPTION VARCHAR2(255),
    ACTION_USER VARCHAR2(50),
    STATUS VARCHAR2(20),
    CREATED_DATE DATE,
    UPDATED_DATE DATE,
    CONSTRAINT PK_DEPARTMENTS PRIMARY KEY (DEPARTMENT_ID)
);

-- DESIGNATION table
CREATE TABLE DESIGNATION (
    DESIGNATION_ID NUMBER NOT NULL,
    DESIGNATION_NAME VARCHAR2(100),
    DESCRIPTION VARCHAR2(255),
    ACTION_USER VARCHAR2(50),
    STATUS VARCHAR2(20),
    CREATED_DATE DATE,
    UPDATED_DATE DATE,
    CONSTRAINT PK_DESIGNATION PRIMARY KEY (DESIGNATION_ID)
);

-- EMPLOYEES table
CREATE TABLE EMPLOYEES (
    EMPLOYEE_ID NUMBER NOT NULL,
    FIRST_NAME VARCHAR2(100) NOT NULL,
    LAST_NAME VARCHAR2(100) NOT NULL,
    FATHER_NAME VARCHAR2(100),
    MOTHER_NAME VARCHAR2(100),
    PRESENT_ADDRESS VARCHAR2(350),
    PERMANENT_ADDRESS VARCHAR2(350),
    SALARY NUMBER(10,2),
    JOIN_DATE DATE,
    DATE_OF_BIRTH DATE,
    NID NUMBER,
    EMAIL VARCHAR2(100),
    CONTACT_NO VARCHAR2(100),
    GENDER VARCHAR2(100),
    RELIGION VARCHAR2(100),
    NATIONALITY VARCHAR2(100),
    BLOOD_GROUP VARCHAR2(100),
    DESIGNATION_ID NUMBER NOT NULL,
    DEPARTMENT_ID NUMBER NOT NULL,
    EMPLOYEE_IMAGE BLOB,
    EMPLOYEE_STATUS VARCHAR2(100),
    EMPLOYEE_DESCRIPTION VARCHAR2(300),
    ACTION_USER VARCHAR2(100),
    ACTION_DATE_TIME DATE,
    CREATED_DATE DATE,
    UPDATED_DATE DATE,
    CONSTRAINT PK_EMPLOYEES PRIMARY KEY (EMPLOYEE_ID)
);

--------------------------------------------------------


ALTER TABLE EMPLOYEES
ADD CONSTRAINT FK_EMP_DEPT
FOREIGN KEY (DEPARTMENT_ID)
REFERENCES DEPARTMENTS (DEPARTMENT_ID)
ON DELETE CASCADE;

ALTER TABLE EMPLOYEES
ADD CONSTRAINT FK_EMP_DESIG
FOREIGN KEY (DESIGNATION_ID)
REFERENCES DESIGNATION (DESIGNATION_ID)
ON DELETE CASCADE;


------------------------------------------------------

-- PRODUCT_CATEGORY table
CREATE TABLE PRODUCT_CATEGORY (
    CATEGORY_ID NUMBER NOT NULL,
    CATEGORY_NAME VARCHAR2(100),
    DESCRIPTION VARCHAR2(255),
    ACTION_USER VARCHAR2(50),
    STATUS VARCHAR2(20),
    CREATED_DATE DATE,
    UPDATED_DATE DATE,
    CONSTRAINT PK_PRODUCT_CATEGORY PRIMARY KEY (CATEGORY_ID)
);

-- PRODUCT_BRAND table
CREATE TABLE PRODUCT_BRAND (
    BRAND_ID NUMBER NOT NULL,
    BRAND_NAME VARCHAR2(100) NOT NULL,
    DESCRIPTION VARCHAR2(255),
    ACTION_USER VARCHAR2(50),
    STATUS VARCHAR2(20),
    CREATED_DATE DATE,
    UPDATED_DATE DATE,
    CONSTRAINT PK_PRODUCT_BRAND PRIMARY KEY (BRAND_ID)
);

-- PRODUCT_TYPE table
CREATE TABLE PRODUCT_TYPE (
    TYPE_ID NUMBER NOT NULL,
    TYPE_NAME VARCHAR2(100),
    DESCRIPTION VARCHAR2(255),
    ACTION_USER VARCHAR2(50),
    STATUS VARCHAR2(20),
    CREATED_DATE DATE,
    UPDATED_DATE DATE,
    CONSTRAINT PK_PRODUCT_TYPE PRIMARY KEY (TYPE_ID)
);


-- PRODUCTS table
CREATE TABLE PRODUCTS (
    PRODUCT_ID NUMBER NOT NULL,
    PRODUCT_NAME VARCHAR2(150),
    PURCHASE_PRICE NUMBER(10,2),
    SELL_PRICE NUMBER(10,2),
    UNIT_PRICE NUMBER(10,2),
    STOCK_QTY NUMBER,
    BRAND_ID NUMBER,
    CATEGORY_ID NUMBER,
    TYPE_ID NUMBER,
    SKU VARCHAR2(50),
    CREATED_DATE DATE,
    UPDATED_DATE DATE,
    DESCRIPTION VARCHAR2(255),
    CONSTRAINT PK_PRODUCTS PRIMARY KEY (PRODUCT_ID)
);



--------------------------------------------------------
ALTER TABLE PRODUCTS
ADD CONSTRAINT FK_PRODUCTS_CATEGORY
FOREIGN KEY (CATEGORY_ID)
REFERENCES PRODUCT_CATEGORY (CATEGORY_ID)
ON DELETE CASCADE;

ALTER TABLE PRODUCTS
ADD CONSTRAINT FK_PRODUCTS_BRAND
FOREIGN KEY (BRAND_ID)
REFERENCES PRODUCT_BRAND (BRAND_ID)
ON DELETE CASCADE;

ALTER TABLE PRODUCTS
ADD CONSTRAINT FK_PRODUCTS_TYPE
FOREIGN KEY (TYPE_ID)
REFERENCES PRODUCT_TYPE (TYPE_ID)
ON DELETE CASCADE;

--------------------------------------------------------


-- WAREHOUSE_LIST table
CREATE TABLE WAREHOUSE_LIST (
    WAREHOUSE_LIST_ID NUMBER(38) NOT NULL,
    WAREHOUSE_CODE VARCHAR2(20),
    WAREHOUSE_NAME VARCHAR2(100) NOT NULL,
    LOCATION VARCHAR2(100),
    CITY VARCHAR2(50),
    CAPACITY NUMBER(38),
    STATUS VARCHAR2(20),
    REMARKS VARCHAR2(255),
    CREATED_DATE DATE,
    UPDATED_DATE DATE,
    CONSTRAINT PK_WAREHOUSE_LIST PRIMARY KEY (WAREHOUSE_LIST_ID)
);

-- SUPPLIERS table
CREATE TABLE SUPPLIERS (
    SUPPLIER_ID NUMBER(38) NOT NULL,
    SUPPLIER_NAME VARCHAR2(150),
    CONTACT_PERSON VARCHAR2(100),
    CONTACT_NO VARCHAR2(20),
    EMAIL VARCHAR2(100),
    CITY VARCHAR2(50),
    TIN_NUMBER VARCHAR2(50),
    CREATED_DATE DATE,
    UPDATED_DATE DATE,
    PAYMENT_TERMS VARCHAR2(50),
    CONSTRAINT PK_SUPPLIERS PRIMARY KEY (SUPPLIER_ID)
);



-- REQ_MASTER table
CREATE TABLE REQ_MASTER (
    REQUISITION_ID NUMBER NOT NULL,
    REQUISITION_DATE DATE,
    CREATE_DATE DATE,
    TOTAL_AMOUNT NUMBER,
    REMARKS VARCHAR2(200),
    CREATE_BY VARCHAR2(100),
    QUOT_STATUS NUMBER,
    CONSTRAINT PK_REQ_MASTER PRIMARY KEY (REQUISITION_ID)
);

-- REQ_DETAILS table
CREATE TABLE REQ_DETAILS (
    REQ_DETAIL_ID NUMBER NOT NULL,
    REQUISITION_ID NUMBER,
    QTY_REQUESTED NUMBER,
    REMARKS VARCHAR2(100),
    PRODUCT_ID NUMBER,
    PRODUCT_NAME VARCHAR2(100),
    PURCHASE_PRICE NUMBER,
    SELL_PRICE NUMBER,
    CREATE_DATE DATE,
    CREATE_BY VARCHAR2(100),
    CONSTRAINT PK_REQ_DETAILS PRIMARY KEY (REQ_DETAIL_ID)
);

CREATE SEQUENCE REQ_DETAILS_SEQ
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

----------------------------------------
ALTER TABLE REQ_DETAILS ADD CONSTRAINT FK_REQ_DETAILS_MASTER 
FOREIGN KEY (REQUISITION_ID) 
REFERENCES REQ_MASTER (REQUISITION_ID);

ALTER TABLE REQ_DETAILS ADD CONSTRAINT FK_REQ_DETAILS_PRODUCTS 
FOREIGN KEY (PRODUCT_ID) 
REFERENCES PRODUCTS (PRODUCT_ID);



----------------------------------------
-- QUOTATION_MASTER table
CREATE TABLE QUOTATION_MASTER (
    QUOT_MASTER_ID NUMBER NOT NULL,
    REQ_ID NUMBER,
    QUOT_DATE DATE,
    CREATE_BY VARCHAR2(50),
    CREATE_DATE DATE,
    UPDATE_BY VARCHAR2(50),
    UPDATE_DATE DATE,
    APPROVED NUMBER,
    CONSTRAINT PK_QUOTATION_MASTER PRIMARY KEY (QUOT_MASTER_ID)
);

-- QUOTATION_DETAILS table
CREATE TABLE QUOTATION_DETAILS (
    QUOT_DET_ID NUMBER NOT NULL,
    QUOT_MASTER_ID NUMBER NOT NULL,
    SUPPLIER_ID NUMBER,
    PRODUCT_ID NUMBER,
    REQ_QUANTITY NUMBER,
    QUTE_QUANTITY NUMBER,
    QUOTATION_PRICE NUMBER(10,2),
    DELIVERY_DATE DATE,
    STATUS VARCHAR2(20),
    REMARKS VARCHAR2(255),
    PRODUCT_NAME VARCHAR2(100),
    SUPPLIER_NAME VARCHAR2(100),
    APPROVE_STATUS VARCHAR2(20),
    APPROVED NUMBER,
    CONSTRAINT PK_QUOTATION_DETAILS PRIMARY KEY (QUOT_DET_ID)
);

CREATE SEQUENCE QUOT_DET_ID_SEQ
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

-------------------------------------------------------
ALTER TABLE QUOTATION_DETAILS 
ADD CONSTRAINT FK_QUOTATION_DETAILS_MASTER
FOREIGN KEY (QUOT_MASTER_ID)
REFERENCES QUOTATION_MASTER (QUOT_MASTER_ID)
ON DELETE CASCADE;

ALTER TABLE QUOTATION_DETAILS 
ADD CONSTRAINT FK_QUOTATION_DETAILS_PRODUCT
FOREIGN KEY (PRODUCT_ID)
REFERENCES PRODUCTS (PRODUCT_ID);


-------------------------------------------------------

-- QUOTATION_APPROVE table
CREATE TABLE QUOTATION_APPROVE (
    QUOT_DET_ID NUMBER NOT NULL,
    QUOT_APPROVE_ID NUMBER,
    QUOT_MASTER_ID NUMBER,
    SUPPLIER_ID NUMBER,
    PRODUCT_ID NUMBER,
    REQ_QUANTITY NUMBER,
    QUTE_QUANTITY NUMBER,
    QUOTATION_PRICE NUMBER(10,2),
    DELIVERY_DATE DATE,
    STATUS VARCHAR2(50),
    REMARKS VARCHAR2(255),
    PRODUCT_NAME VARCHAR2(100),
    SUPPLIER_NAME VARCHAR2(100),
    APPROVE_STATUS VARCHAR2(20),
    APPROVED NUMBER,
    CONSTRAINT PK_QUOTATION_APPROVE PRIMARY KEY (QUOT_DET_ID)
);

-----------------------------------------------------------
ALTER TABLE QUOTATION_APPROVE 
ADD CONSTRAINT FK_QUOTATION_APPROVE_MASTER
FOREIGN KEY (QUOT_MASTER_ID)
REFERENCES QUOTATION_MASTER (QUOT_MASTER_ID)
ON DELETE CASCADE;

ALTER TABLE QUOTATION_APPROVE 
ADD CONSTRAINT FK_QUOTATION_APPROVE_PRODUCT
FOREIGN KEY (PRODUCT_ID)
REFERENCES PRODUCTS (PRODUCT_ID);

ALTER TABLE QUOTATION_APPROVE 
ADD CONSTRAINT FK_QUOTATION_APPROVE_SUPPLIER
FOREIGN KEY (SUPPLIER_ID)
REFERENCES SUPPLIERS (SUPPLIER_ID);

-----------------------------------------------------------

-- PURCHASE_MASTER table
CREATE TABLE PURCHASE_MASTER (
    PURCHASE_ID NUMBER NOT NULL,
    QUOT_MASTER_ID NUMBER,
    PURCHASE_DATE DATE,
    TOTAL_AMOUNT NUMBER(10,2),
    CREATED_BY VARCHAR2(50),
    APPROVED_BY VARCHAR2(50),
    APPROVAL_STATUS VARCHAR2(20),
    PAYMENT_STATUS VARCHAR2(20),
    REMARKS VARCHAR2(255),
    CREATED_DATE DATE,
    MODIFIED_DATE DATE,
    QUATATION_APPROVE_ID NUMBER,
    SUPPLIER_NAME VARCHAR2(100),
    NET_TOTAL_AMOUNT NUMBER(10,2),
    PERCENTAGE NUMBER(5,2),
    VAT NUMBER(10,2),
    BILL_AMOUNT NUMBER(10,2),
    GIVEN_AMOUNT NUMBER(10,2),
    DUE_AMOUNT NUMBER(10,2),
    NET_AMOUNT NUMBER(10,2),
    SUPPLIER_ID NUMBER,
    PURCHASE_DONE NUMBER,
    CONSTRAINT PK_PURCHASE_MASTER PRIMARY KEY (PURCHASE_ID)
);

-- PURCHASE_DETAILS table
CREATE TABLE PURCHASE_DETAILS (
    PURCHASE_DETAIL_ID NUMBER NOT NULL,
    PURCHASE_ID NUMBER,
    TOTAL_PRICE NUMBER(10,2),
    REMARKS VARCHAR2(255),
    CREATED_DATE DATE,
    QUTE_QUANTITY NUMBER,
    QUATATION_PRICE NUMBER(10,2),
    PRODUCT_ID NUMBER,
    PRODUCT_NAME VARCHAR2(100),
    VAT NUMBER(10,2),
    BILL_AMOUNT NUMBER(10,2),
    GIVEN_AMOUNT NUMBER(10,2),
    DUE_AMOUNT NUMBER(10,2),
    VAT_PERCENTAGE NUMBER(5,2),
    NET NUMBER(10,2),
    CONSTRAINT PK_PURCHASE_DETAILS PRIMARY KEY (PURCHASE_DETAIL_ID)
);


----------------------------------------------------
ALTER TABLE PURCHASE_MASTER 
ADD CONSTRAINT FK_PURCHASE_MASTER_QUOTATION
FOREIGN KEY (QUOT_MASTER_ID)
REFERENCES QUOTATION_MASTER (QUOT_MASTER_ID);


ALTER TABLE PURCHASE_MASTER 
ADD CONSTRAINT FK_PURCHASE_MASTER_SUPPLIER
FOREIGN KEY (SUPPLIER_ID)
REFERENCES SUPPLIERS (SUPPLIER_ID);


ALTER TABLE PURCHASE_DETAILS 
ADD CONSTRAINT FK_PURCHASE_DETAILS_MASTER
FOREIGN KEY (PURCHASE_ID)
REFERENCES PURCHASE_MASTER (PURCHASE_ID)
ON DELETE CASCADE;

ALTER TABLE PURCHASE_DETAILS 
ADD CONSTRAINT FK_PURCHASE_DETAILS_PRODUCT
FOREIGN KEY (PRODUCT_ID)
REFERENCES PRODUCTS (PRODUCT_ID);

----------------------------------------------------


CREATE OR REPLACE VIEW VIEW_REQUISITION_DETAILS AS
SELECT 
    rm.REQUISITION_ID,
    rm.REQUISITION_DATE,
    rm.QUOT_STATUS,
    rd.REQ_DETAIL_ID,
    rd.PRODUCT_ID,
    rd.PRODUCT_NAME,
    rd.QTY_REQUESTED,
    rd.PURCHASE_PRICE,
    rd.SELL_PRICE
FROM 
    REQ_MASTER rm
JOIN 
    REQ_DETAILS rd
ON 
    rm.REQUISITION_ID = rd.REQUISITION_ID;



CREATE OR REPLACE VIEW VW_QUOTATION_SUMMARY AS
SELECT
    qm.QUOT_MASTER_ID,
    qm.REQ_ID,
    qm.QUOT_DATE,
    qd.QUOT_DET_ID,
    qd.SUPPLIER_ID,
    qd.PRODUCT_ID,
    qd.REQ_QUANTITY,
    qd.QUTE_QUANTITY,
    qd.QUOTATION_PRICE,
    qd.DELIVERY_DATE
FROM
    QUOTATION_MASTER qm
JOIN
    QUOTATION_DETAILS qd
ON
    qm.QUOT_MASTER_ID = qd.QUOT_MASTER_ID;



CREATE OR REPLACE VIEW VW_PURCHASE_INFO AS
SELECT
    pd.PURCHASE_DETAIL_ID,
    pd.PRODUCT_ID,
    pd.PRODUCT_NAME,
    pd.QUTE_QUANTITY,
    pd.QUATATION_PRICE,
    pd.TOTAL_PRICE,
    pd.VAT_PERCENTAGE,
    pd.NET,
    pm.PURCHASE_ID,
    pm.PURCHASE_DATE,
    pm.SUPPLIER_ID,
    pm.SUPPLIER_NAME,
    pm.TOTAL_AMOUNT,
    pm.VAT,
    pm.BILL_AMOUNT,
    pm.DUE_AMOUNT,
    pm.NET_AMOUNT
FROM
    PURCHASE_DETAILS pd
JOIN
    PURCHASE_MASTER pm
ON
    pd.PURCHASE_ID = pm.PURCHASE_ID;




-- SUPPLIER_DUE_PAYMENT table
CREATE TABLE SUPPLIER_DUE_PAYMENT (
    DUE_PAYMENT_ID NUMBER,
    SUPPLIER_ID NUMBER,
    SUPPLIER_NAME VARCHAR2(100),
    TOTAL_AMOUNT NUMBER,
    DUE_AMOUNT NUMBER,
    COLLECT_AMOUNT NUMBER,
    PURCHASE_ID NUMBER,
    CONSTRAINT PK_SUPPLIER_DUE_PAYMENT PRIMARY KEY (DUE_PAYMENT_ID)
);

-------------------------------------------------
ALTER TABLE SUPPLIER_DUE_PAYMENT
ADD CONSTRAINT FK_SUPPLIER_DUE_PAYMENT_PURCHASE
FOREIGN KEY (PURCHASE_ID)
REFERENCES PURCHASE_MASTER (PURCHASE_ID)
ON DELETE CASCADE;

ALTER TABLE SUPPLIER_DUE_PAYMENT
ADD CONSTRAINT FK_SUPPLIER_DUE_PAYMENT_SUPPLIER
FOREIGN KEY (SUPPLIER_ID)
REFERENCES SUPPLIERS (SUPPLIER_ID);

-------------------------------------------------

-- USER_INFO table
CREATE TABLE USER_INFO (
    USER_ID NUMBER ,
    USERNAME VARCHAR2(100) ,
    PASSWORD VARCHAR2(100) ,
    FULL_NAME VARCHAR2(200),
    EMAIL VARCHAR2(100),
    ROLE VARCHAR2(50),
    STATUS VARCHAR2(50),
    CREATED_AT DATE,
    CONSTRAINT PK_USER_INFO PRIMARY KEY (USER_ID)
);

CREATE OR REPLACE PROCEDURE SCMDB.insert_data_intoQute_approve (
    P_QUOT_MASTER_ID IN NUMBER
)
IS
    CURSOR c IS
        SELECT
            QUOT_DET_ID,
            QUOT_MASTER_ID,
            SUPPLIER_ID,
            PRODUCT_ID,
            REQ_QUANTITY,
            QUTE_QUANTITY,
            QUOTATION_PRICE,
            DELIVERY_DATE,
            STATUS,
            REMARKS,
            PRODUCT_NAME,
            SUPPLIER_NAME
        FROM
            QUOTATION_DETAILS
        WHERE
            QUOT_MASTER_ID = P_QUOT_MASTER_ID;

    v_QUOT_APPROVE_ID NUMBER;
BEGIN
    FOR rec IN c LOOP
        -- If you have a sequence, use this (recommended):
        -- SELECT QUOT_APPROVE_SEQ.NEXTVAL INTO v_QUOT_APPROVE_ID FROM dual;

        -- Otherwise, fallback to MAX + 1
        SELECT NVL(MAX(QUOT_APPROVE_ID), 0) + 1
        INTO v_QUOT_APPROVE_ID
        FROM QUOTATION_APPROVE;

        INSERT INTO QUOTATION_APPROVE (
            QUOT_APPROVE_ID,
            QUOT_DET_ID,
            QUOT_MASTER_ID,
            SUPPLIER_ID,
            PRODUCT_ID,
            REQ_QUANTITY,
            QUTE_QUANTITY,
            QUOTATION_PRICE,
            DELIVERY_DATE,
            STATUS,
            REMARKS,
            PRODUCT_NAME,
            SUPPLIER_NAME,
            APPROVE_STATUS
        )
        VALUES (
            v_QUOT_APPROVE_ID,
            rec.QUOT_DET_ID,
            rec.QUOT_MASTER_ID,
            rec.SUPPLIER_ID,
            rec.PRODUCT_ID,
            rec.REQ_QUANTITY,
            rec.QUTE_QUANTITY,
            rec.QUOTATION_PRICE,
            rec.DELIVERY_DATE,
            rec.STATUS,
            rec.REMARKS,
            rec.PRODUCT_NAME,
            rec.SUPPLIER_NAME,
            'PENDING'
        );
    END LOOP;

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
        ROLLBACK;
END;
/


CREATE OR REPLACE PROCEDURE SCMDB.insert_purchase_history (p_quation_id IN NUMBER)
IS
   CURSOR c_master
   IS
      SELECT SUPPLIER_ID, SUPPLIER_NAME, QUOT_MASTER_ID
        FROM QUOTATION_APPROVE
       WHERE QUOT_APPROVE_ID = p_quation_id;

   CURSOR c_approve_data
   IS
      SELECT *
        FROM QUOTATION_APPROVE
       WHERE QUOT_APPROVE_ID = p_quation_id;

   V_PURCHASE_ID   NUMBER;
   v_PURCHASE_DETAIL_ID number;
BEGIN
   NULL;

   FOR i IN c_master
   LOOP
      SELECT NVL (MAX (PURCHASE_ID), 0) + 1
        INTO V_PURCHASE_ID
        FROM PURCHASE_MASTER;

      INSERT INTO PURCHASE_MASTER (PURCHASE_ID,
                                   QUOT_MASTER_ID,
                                   SUPPLIER_ID,
                                   SUPPLIER_NAME)
           VALUES (V_PURCHASE_ID,
                   i.QUOT_MASTER_ID,
                   i.SUPPLIER_ID,
                   i.SUPPLIER_NAME);

      COMMIT;
   END LOOP;

   FOR a IN c_approve_data
   LOOP
      SELECT NVL (MAX (PURCHASE_DETAIL_ID),0) +1
        INTO v_PURCHASE_DETAIL_ID
        FROM PURCHASE_DETAILS;

      INSERT INTO PURCHASE_DETAILS (PURCHASE_DETAIL_ID,
                                    PURCHASE_ID,
                                    PRODUCT_ID,
                                    PRODUCT_NAME,
                                    QUTE_QUANTITY,
                                    QUATATION_PRICE)
           VALUES (v_PURCHASE_DETAIL_ID,
                   V_PURCHASE_ID,
                   a.PRODUCT_ID,
                   a.PRODUCT_NAME,
                   a.QUTE_QUANTITY,
                   a.QUOTATION_PRICE);
   END LOOP;
   commit;
END;
/

CREATE TABLE CUSTOMER (
    CUSTOMER_ID      NUMBER PRIMARY KEY,
    CUSTOMER_NAME    VARCHAR2(100),
    GENDER           VARCHAR2(10),
    PHONE_NUMBER     VARCHAR2(20),
    EMAIL            VARCHAR2(100),
    ADDRESS          VARCHAR2(200),
    CREATED_BY       VARCHAR2(50),
    CREATED_DATE     DATE DEFAULT SYSDATE,
    UPDATED_BY       VARCHAR2(50),
    UPDATED_DATE     DATE
);

CREATE TABLE SELL_ORDER_MASTER (
    SELL_ORDER_ID        NUMBER PRIMARY KEY,
    CUSTOMER_ID          NUMBER,
    SALE_DATE            DATE,
    CUST_PHONE           VARCHAR2(15),

    TOTAL_AMOUNT         NUMBER(10, 2),
    PAID_AMOUNT          NUMBER(10, 2),
    DUE_AMOUNT           NUMBER(10, 2),
    DISCOUNT_PERCENTAGE  NUMBER(5, 2),
    DISCOUNT_AMOUNT      NUMBER(10, 2),
    NET_PAYABLE_AMO      NUMBER(10, 2),

    -- ⭐ EXTRA professional columns
    INVOICE_NO           VARCHAR2(50),
    PAYMENT_METHOD       VARCHAR2(30),      -- CASH / CARD / BKASH / NAGAD / BANK
    PAYMENT_STATUS       VARCHAR2(20),      -- PAID / PARTIAL / DUE
    DELIVERY_STATUS      VARCHAR2(20),      -- PENDING / SHIPPED / DELIVERED
    NOTES                VARCHAR2(300),

    CREATED_BY           VARCHAR2(50),
    CREATED_DATE         DATE DEFAULT SYSDATE,
    UPDATED_BY           VARCHAR2(50),
    UPDATED_DATE         DATE
);



ALTER TABLE SELL_ORDER_MASTER
ADD CONSTRAINT FK_SELL_CUST
FOREIGN KEY (CUSTOMER_ID)
REFERENCES CUSTOMER (CUSTOMER_ID);



CREATE TABLE SELL_ORDER_DETAILS (
    SELL_ORDER_DETAIL_ID NUMBER PRIMARY KEY,
    SELL_ORDER_ID        NUMBER,
    PRODUCT_ID           NUMBER,           -- MATCHES PRODUCTS TABLE
    PRODUCT_NAME         VARCHAR2(100),
    AVAILABLE_STOCK_QTY NUMBER,
    UNIT_TYPE            VARCHAR2(10),
    PRICE                NUMBER(10, 2),
    QUANTITY             NUMBER,
    TOTAL_AMOUNT         NUMBER(10, 2),

    -- ⭐ EXTRA professional columns
    DISCOUNT_PERCENT      NUMBER(5,2),
    DISCOUNT_AMOUNT       NUMBER(10,2),
    TAX_PERCENT           NUMBER(5,2),
    TAX_AMOUNT            NUMBER(10,2),
    WAREHOUSE_NAME        VARCHAR2(100),
    SERIAL_NUMBER         VARCHAR2(100),
    NOTES                 VARCHAR2(200),

    CREATED_BY            VARCHAR2(50),
    CREATED_DATE          DATE DEFAULT SYSDATE
);



ALTER TABLE SELL_ORDER_DETAILS
ADD CONSTRAINT FK_SELL_ORDER_MASTER
FOREIGN KEY (SELL_ORDER_ID)
REFERENCES SELL_ORDER_MASTER (SELL_ORDER_ID);

ALTER TABLE SELL_ORDER_DETAILS
ADD CONSTRAINT FK_PRODUCTS
FOREIGN KEY (PRODUCT_ID)
REFERENCES PRODUCTS (PRODUCT_ID);





CREATE OR REPLACE FORCE VIEW SCMDB.STOCK_VIEW
(
    PRODUCT_ID,
    PRODUCT_NAME,
    CATEGORY_ID,
    CATEGORY_NAME,
    BRAND_ID,
    BRAND_NAME,
    TYPE_ID,
    TYPE_NAME,
    STOCK_QTY
)
BEQUEATH DEFINER
AS
SELECT
       p.product_id,
       p.product_name,

       pc.category_id,
       pc.category_name,

       pb.brand_id,
       pb.brand_name,

       pt.type_id,
       pt.type_name,

       SUM(iq.stock_qty) AS stock_qty
FROM
(
        -- Purchase (increase stock)
        SELECT
               product_id,
               SUM(qute_quantity) AS stock_qty
        FROM SCMDB.purchase_details
        GROUP BY product_id

        UNION ALL

        -- Sales (decrease stock)
        SELECT
               product_id,
               -SUM(quantity) AS stock_qty
        FROM SCMDB.sell_order_details
        GROUP BY product_id
) iq
JOIN SCMDB.products p
      ON p.product_id = iq.product_id
LEFT JOIN SCMDB.product_category pc
      ON p.category_id = pc.category_id
LEFT JOIN SCMDB.product_brand pb
      ON p.brand_id = pb.brand_id
LEFT JOIN SCMDB.product_type pt
      ON p.type_id = pt.type_id
GROUP BY
       p.product_id,
       p.product_name,
       pc.category_id,
       pc.category_name,
       pb.brand_id,
       pb.brand_name,
       pt.type_id,
       pt.type_name
/
commit;
